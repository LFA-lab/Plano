<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Interne</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border: 2px solid #000;
            padding: 20px;
        }
        
        /* En-t√™te */
        h1 {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: left;
        }
        
        /* Layout principal */
        .main-layout {
            margin-top: 20px;
        }
        
        /* Section gauche */
        .left-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Boutons et onglets */
        .tabs-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 8px 16px;
            background: white;
            border: 1px solid #000;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            background: #e8e8e8;
        }
        
        .tab-button.active {
            background: #d0d0d0;
            border-width: 2px;
        }
        
        /* Menu d√©roulant */
        .zone-select {
            padding: 7px 12px;
            border: 1px solid #000;
            font-size: 11px;
            background: white;
            cursor: pointer;
        }
        
        /* Section graphique */
        .chart-section {
            border: 1px solid #000;
            padding: 15px;
        }
        
        .chart-title {
            text-align: center;
            font-size: 12px;
            font-weight: normal;
            margin-bottom: 15px;
        }
        
        .chart-container-wrapper {
            position: relative;
            height: 280px;
        }
        
        /* Labels verticaux */
        .chart-labels {
            display: flex;
            flex-direction: column;
            gap: 28px;
            position: absolute;
            left: 0;
            top: 20px;
        }
        
        .chart-label {
            font-size: 9px;
            text-align: right;
            width: 120px;
        }
        
        .chart-label.rotated {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            width: auto;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        /* Zone de barres */
        .bars-container {
            margin-left: 130px;
            margin-top: 15px;
            position: relative;
        }
        
        .bar-row {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            height: 22px;
            align-items: center;
        }
        
        .bar {
            height: 20px;
            background: linear-gradient(to right, #FF0000 0%, #FFFF00 50%, #00B050 100%);
            position: relative;
        }
        
        /* Axe X */
        .x-axis {
            display: flex;
            justify-content: space-between;
            margin-left: 130px;
            margin-top: 5px;
            padding-right: 10px;
            border-top: 1px solid #000;
            padding-top: 5px;
        }
        
        .x-axis-label {
            font-size: 10px;
        }
        
        /* Vue cach√©e par d√©faut */
        .view-section {
            display: none;
        }
        
        .view-section.active {
            display: block;
        }
        
        /* Page d'accueil */
        .home-view {
            padding: 40px 20px;
            text-align: center;
        }
        
        .home-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 40px;
            color: #333;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .dashboard-card {
            background: white;
            border: 2px solid #000;
            padding: 40px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .dashboard-card:hover {
            background: #f0f0f0;
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        .dashboard-card-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .dashboard-card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .dashboard-card-description {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }
        
        /* Bouton retour */
        .back-button {
            padding: 8px 16px;
            background: #666;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 15px;
        }
        
        .back-button:hover {
            background: #444;
        }
        
        /* Navigation dans les sous-vues */
        .sub-navigation {
            display: none;
            margin-bottom: 15px;
        }
        
        .sub-navigation.active {
            display: block;
        }
        
        /* Dashboard √âlectrique */
        .electrical-dashboard {
            margin-top: 20px;
        }
        
        .electrical-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .electrical-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn-view-all {
            padding: 8px 16px;
            background: white;
            border: 1px solid #000;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-view-all:hover {
            background: #e8e8e8;
        }
        
        .select-action {
            padding: 7px 12px;
            border: 1px solid #000;
            font-size: 11px;
            background: white;
            cursor: pointer;
            min-width: 150px;
        }
        
        .electrical-right {
            font-size: 10px;
            color: #666;
            font-style: italic;
            max-width: 300px;
        }
        
        /* Tableau de progression */
        .progress-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #000;
            margin-bottom: 20px;
        }
        
        .progress-table th,
        .progress-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            font-size: 11px;
        }
        
        .progress-table th {
            background: #e0e0e0;
            font-weight: 600;
        }
        
        .progress-table td.action-name {
            text-align: left;
            font-weight: 600;
            background: #f5f5f5;
        }
        
        .progress-table td.percentage {
            font-weight: 600;
        }
        
        .progress-table td.percentage.low {
            color: #d32f2f;
        }
        
        .progress-table td.percentage.medium {
            color: #f57c00;
        }
        
        .progress-table td.percentage.high {
            color: #388e3c;
        }
        
        .comparatif-note {
            font-size: 11px;
            color: #666;
            font-style: italic;
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #ddd;
        }
        
        /* Dashboard Financier */
        .financial-dashboard {
            margin-top: 20px;
        }
        
        .financial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border: 1px solid #000;
        }
        
        .date-selector-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-selector-label {
            font-size: 11px;
            font-weight: 600;
        }
        
        .date-selector {
            padding: 7px 12px;
            border: 1px solid #000;
            font-size: 11px;
            background: white;
            cursor: pointer;
        }
        
        .financial-summary {
            text-align: right;
        }
        
        .financial-summary-title {
            font-size: 10px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .financial-summary-amount {
            font-size: 20px;
            font-weight: bold;
            color: #2e7d32;
        }
        
        /* Tableau des tranches */
        .tranches-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #000;
            margin-bottom: 20px;
        }
        
        .tranches-table th,
        .tranches-table td {
            border: 1px solid #000;
            padding: 10px;
            font-size: 11px;
        }
        
        .tranches-table th {
            background: #e0e0e0;
            font-weight: 600;
            text-align: center;
        }
        
        .tranches-table td.tranche-name {
            font-weight: 600;
            background: #f5f5f5;
            width: 120px;
        }
        
        .tranches-table td.sub-category {
            padding-left: 30px;
            font-size: 10px;
            background: #fafafa;
        }
        
        .tranches-table td.amount {
            text-align: right;
            font-weight: 600;
            color: #2e7d32;
        }
        
        .tranches-table td.percentage {
            text-align: center;
            font-weight: 600;
        }
        
        /* Timeline mensuelle */
        .timeline-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .timeline-header {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .timeline-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            min-width: 800px;
        }
        
        .timeline-labels {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .timeline-label {
            font-size: 10px;
            font-weight: 600;
            height: 30px;
            display: flex;
            align-items: center;
        }
        
        .timeline-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .timeline-bar-row {
            display: flex;
            align-items: center;
            height: 30px;
            position: relative;
            background: #f0f0f0;
            border: 1px solid #ddd;
        }
        
        .timeline-bar {
            height: 100%;
            background: linear-gradient(to right, #FF5722 0%, #FFC107 50%, #4CAF50 100%);
            transition: width 0.3s ease;
            position: relative;
        }
        
        .timeline-bar-label {
            position: absolute;
            right: 5px;
            font-size: 10px;
            font-weight: 600;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .timeline-months {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 9px;
            color: #666;
        }
        
        /* Total facturable */
        .total-section {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border: 2px solid #4caf50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .total-label {
            font-size: 14px;
            font-weight: 600;
        }
        
        .total-amount {
            font-size: 24px;
            font-weight: bold;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>STRUCTURE DU DASHBOARD INTERNE</h1>
        
        <!-- Page d'accueil -->
        <div id="home-view" class="view-section active">
            <div class="home-view">
                <div class="home-title">Choisissez votre dashboard</div>
                <div class="dashboard-cards">
                    <div class="dashboard-card" data-dashboard="mechanical">
                        <div class="dashboard-card-icon">‚öôÔ∏è</div>
                        <div class="dashboard-card-title">Dashboard M√©canique</div>
                        <div class="dashboard-card-description">
                            Suivi des forages, micropieux, structures et contr√¥les qualit√© associ√©s
                        </div>
                    </div>
                    <div class="dashboard-card" data-dashboard="electrical">
                        <div class="dashboard-card-icon">‚ö°</div>
                        <div class="dashboard-card-title">Dashboard √âlectrique</div>
                        <div class="dashboard-card-description">
                            Suivi des actions √©lectriques par onduleur (tirage c√¢bles, raccordement, tests, etc.)
                        </div>
                    </div>
                    <div class="dashboard-card" data-dashboard="financial">
                        <div class="dashboard-card-icon">üí∞</div>
                        <div class="dashboard-card-title">Dashboard Financier</div>
                        <div class="dashboard-card-description">
                            Suivi des montants facturables par tranche selon l'avancement (MECA, MOD, ELEC)
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard M√©canique -->
        <div id="mechanical-view" class="view-section">
            <button class="back-button" id="btnBackFromMeca">‚Üê Retour √† l'accueil</button>
            
            <!-- Premi√®re rang√©e d'onglets -->
            <div class="tabs-row sub-navigation active">
                <button class="tab-button active" data-view="main" data-category="forages">Forages</button>
                <button class="tab-button" data-view="main" data-category="micropieux">Micropieux</button>
                <button class="tab-button" data-view="main" data-category="structures">Structures</button>
            </div>
            
            <!-- Deuxi√®me rang√©e d'onglets -->
            <div class="tabs-row sub-navigation active">
                <button class="tab-button" data-cq="forages">
                    <span class="cq-label">CQ</span> Forages
                </button>
                <button class="tab-button" data-cq="micropieux">
                    <span class="cq-label">CQ</span> Micropieux
                </button>
                <button class="tab-button" data-cq="structures">
                    <span class="cq-label">CQ</span> Structures
                </button>
            <select class="zone-select" id="zoneSelect">
                <option value="">Toutes les zones</option>
                <option value="zone1">Zone 1</option>
                <option value="zone2">Zone 2</option>
                <option value="zone3">Zone 3</option>
                <option value="zone4">Zone 4</option>
            </select>
            </div>
            
            <!-- Graphiques m√©caniques -->
            <div class="main-layout">
                <div class="left-section">
                    <div class="chart-section">
                        <div class="chart-title">Affichage sur la zone voulue √† date</div>
                        
                        <div class="chart-container-wrapper">
                            <!-- Labels verticaux -->
                            <div class="chart-labels">
                                <div class="chart-label rotated">CQ forages r√©el</div>
                                <div class="chart-label rotated">CQ Forages Pr√©vu</div>
                                <div class="chart-label">Forages</div>
                                <div class="chart-label rotated">Forages R√©els</div>
                                <div class="chart-label rotated">Forages Pr√©vu</div>
                            </div>
                            
                            <!-- Barres horizontales -->
                            <div class="bars-container">
                                <div class="bar-row">
                                    <div class="bar" id="bar1" style="width: 5%;"></div>
                                </div>
                                <div class="bar-row">
                                    <div class="bar" id="bar2" style="width: 12%;"></div>
                                </div>
                                <div class="bar-row" style="height: 8px;"></div>
                                <div class="bar-row">
                                    <div class="bar" id="bar3" style="width: 65%;"></div>
                                </div>
                                <div class="bar-row">
                                    <div class="bar" id="bar4" style="width: 72%;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Axe X -->
                        <div class="x-axis">
                            <span class="x-axis-label">0%</span>
                            <span class="x-axis-label">10%</span>
                            <span class="x-axis-label">20%</span>
                            <span class="x-axis-label">30%</span>
                            <span class="x-axis-label">40%</span>
                            <span class="x-axis-label">50%</span>
                            <span class="x-axis-label">60%</span>
                            <span class="x-axis-label">70%</span>
                            <span class="x-axis-label">80%</span>
                            <span class="x-axis-label">90%</span>
                            <span class="x-axis-label">100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard √âlectrique -->
        <div id="electrical-view" class="view-section">
            <button class="back-button" id="btnBackFromElec">‚Üê Retour √† l'accueil</button>
            
            <div class="electrical-dashboard">
                <div class="electrical-header">
                    <div class="electrical-left">
                        <button class="btn-view-all" id="btnViewAll">Tout voir</button>
                        <select class="select-action" id="selectAction">
                            <option value="">actions √©lec</option>
                            <option value="action1">Action 1 - Tirage c√¢bles</option>
                            <option value="action2">Action 2 - Raccordement</option>
                            <option value="action3">Action 3 - Tests</option>
                            <option value="action4">Action 4 - Mise en service</option>
                        </select>
                    </div>
                    <div class="electrical-right">
                        Menu d√©roulant pour s√©lectionner une t√¢che pr√©cise ou une autre option
                    </div>
                </div>
                
                <table class="progress-table" id="progressTable">
                    <thead>
                        <tr>
                            <th>Action</th>
                            <th>OND1</th>
                            <th>OND2</th>
                            <th>OND3</th>
                            <th>OND4</th>
                            <th>OND5</th>
                            <th>OND6</th>
                        </tr>
                    </thead>
                    <tbody id="progressTableBody">
                        <!-- Les lignes seront g√©n√©r√©es dynamiquement -->
                    </tbody>
                </table>
                
                <div class="comparatif-note">
                    Comparatif avec un planning de ref ???
                </div>
            </div>
        </div>
        
        <!-- Dashboard Financier -->
        <div id="financial-view" class="view-section">
            <button class="back-button" id="btnBackFromFinancial">‚Üê Retour √† l'accueil</button>
            
            <div class="financial-dashboard">
                <!-- En-t√™te avec s√©lecteur de date -->
                <div class="financial-header">
                    <div class="date-selector-container">
                        <span class="date-selector-label">Date de r√©f√©rence :</span>
                        <input type="date" id="dateSelector" class="date-selector">
                    </div>
                    <div class="financial-summary">
                        <div class="financial-summary-title">Montant total facturable √† date</div>
                        <div class="financial-summary-amount" id="totalFacturable">0 ‚Ç¨</div>
                    </div>
                </div>
                
                <!-- Tableau des tranches -->
                <table class="tranches-table" id="tranchesTable">
                    <thead>
                        <tr>
                            <th>Tranche / Cat√©gorie</th>
                            <th>Montant Total (‚Ç¨)</th>
                            <th>% Avancement</th>
                            <th>Montant Facturable (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody id="tranchesTableBody">
                        <!-- Les lignes seront g√©n√©r√©es dynamiquement -->
                    </tbody>
                </table>
                
                <!-- Timeline mensuelle -->
                <div class="timeline-container">
                    <div class="timeline-header">Timeline d'avancement par tranche</div>
                    <div class="timeline-grid">
                        <div class="timeline-labels" id="timelineLabels">
                            <!-- G√©n√©r√© dynamiquement -->
                        </div>
                        <div>
                            <div class="timeline-bars" id="timelineBars">
                                <!-- G√©n√©r√© dynamiquement -->
                            </div>
                            <div class="timeline-months">
                                <span>Jan</span>
                                <span>F√©v</span>
                                <span>Mar</span>
                                <span>Avr</span>
                                <span>Mai</span>
                                <span>Jun</span>
                                <span>Jul</span>
                                <span>Ao√ª</span>
                                <span>Sep</span>
                                <span>Oct</span>
                                <span>Nov</span>
                                <span>D√©c</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Total facturable -->
                <div class="total-section">
                    <span class="total-label">TOTAL FACTURABLE √Ä DATE</span>
                    <span class="total-amount" id="totalFacturableBottom">0 ‚Ç¨</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Donn√©es de d√©monstration
        const demoData = {
            forages: {
                zone1: { cqReel: 15, cqPrevu: 35, reel: 85, prevu: 92 },
                zone2: { cqReel: 22, cqPrevu: 40, reel: 78, prevu: 88 },
                zone3: { cqReel: 18, cqPrevu: 38, reel: 82, prevu: 90 },
                zone4: { cqReel: 12, cqPrevu: 32, reel: 88, prevu: 95 },
                all: { cqReel: 17, cqPrevu: 36, reel: 83, prevu: 91 }
            },
            micropieux: {
                zone1: { cqReel: 25, cqPrevu: 45, reel: 70, prevu: 80 },
                zone2: { cqReel: 30, cqPrevu: 50, reel: 65, prevu: 75 },
                zone3: { cqReel: 28, cqPrevu: 48, reel: 68, prevu: 78 },
                zone4: { cqReel: 20, cqPrevu: 42, reel: 73, prevu: 82 },
                all: { cqReel: 26, cqPrevu: 46, reel: 69, prevu: 79 }
            },
            structures: {
                zone1: { cqReel: 40, cqPrevu: 60, reel: 75, prevu: 88 },
                zone2: { cqReel: 45, cqPrevu: 65, reel: 70, prevu: 85 },
                zone3: { cqReel: 42, cqPrevu: 62, reel: 73, prevu: 87 },
                zone4: { cqReel: 38, cqPrevu: 58, reel: 78, prevu: 90 },
                all: { cqReel: 41, cqPrevu: 61, reel: 74, prevu: 88 }
            }
        };
        
        // Donn√©es de d√©monstration pour le dashboard √©lectrique
        const demoElectricalData = {
            actions: [
                {
                    name: "Tirage c√¢bles",
                    ond1: 85,
                    ond2: 92,
                    ond3: 78,
                    ond4: 95,
                    ond5: 88,
                    ond6: 90
                },
                {
                    name: "Raccordement",
                    ond1: 65,
                    ond2: 72,
                    ond3: 58,
                    ond4: 80,
                    ond5: 68,
                    ond6: 75
                },
                {
                    name: "Tests √©lectriques",
                    ond1: 45,
                    ond2: 52,
                    ond3: 38,
                    ond4: 60,
                    ond5: 48,
                    ond6: 55
                },
                {
                    name: "Mise en service",
                    ond1: 25,
                    ond2: 32,
                    ond3: 18,
                    ond4: 40,
                    ond5: 28,
                    ond6: 35
                },
                {
                    name: "Contr√¥le final",
                    ond1: 15,
                    ond2: 22,
                    ond3: 8,
                    ond4: 30,
                    ond5: 18,
                    ond6: 25
                }
            ]
        };
        
        // Donn√©es de d√©monstration pour le dashboard financier
        const demoFinancialData = {
            tranches: [
                {
                    name: "Tranche 1",
                    categories: [
                        { name: "MECA", amount: 450000, startMonth: 0, endMonth: 6, progress: 85 },
                        { name: "MOD", amount: 280000, startMonth: 1, endMonth: 5, progress: 92 },
                        { name: "ELEC", amount: 320000, startMonth: 2, endMonth: 7, progress: 78 }
                    ]
                },
                {
                    name: "Tranche 2",
                    categories: [
                        { name: "MECA", amount: 520000, startMonth: 3, endMonth: 9, progress: 65 },
                        { name: "MOD", amount: 310000, startMonth: 4, endMonth: 8, progress: 72 },
                        { name: "ELEC", amount: 380000, startMonth: 5, endMonth: 10, progress: 58 }
                    ]
                },
                {
                    name: "Tranche 3",
                    categories: [
                        { name: "MECA", amount: 490000, startMonth: 6, endMonth: 11, progress: 45 },
                        { name: "MOD", amount: 295000, startMonth: 7, endMonth: 11, progress: 52 },
                        { name: "ELEC", amount: 350000, startMonth: 8, endMonth: 11, progress: 38 }
                    ]
                }
            ]
        };
        
        let projectData = null; // Pour le futur branchement sur export MS Project
        let currentCategory = 'forages';
        let currentZone = 'all';
        let currentView = 'home';
        let selectedDate = new Date();
        
        // Formater un montant en euros
        function formatAmount(amount) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount) + ' ‚Ç¨';
        }
        
        // Calculer le pourcentage d'avancement √† une date donn√©e
        function calculateProgressAtDate(category, date) {
            // Pour la d√©mo, on utilise le pourcentage d√©j√† d√©fini
            // Dans la vraie version, on calculerait selon la date
            const selectedMonth = date.getMonth();
            const currentMonth = new Date().getMonth();
            
            // Si la date s√©lectionn√©e est dans le futur, limiter l'avancement
            if (selectedMonth > currentMonth) {
                return Math.min(category.progress, 
                    Math.floor(category.progress * (selectedMonth / 11)));
            }
            
            return category.progress;
        }
        
        // Afficher le tableau des tranches financi√®res
        function renderFinancialTable(date) {
            const tbody = document.getElementById('tranchesTableBody');
            const data = projectData && projectData.financial 
                ? projectData.financial.tranches 
                : demoFinancialData.tranches;
            
            let html = '';
            let totalFacturable = 0;
            
            data.forEach(tranche => {
                let trancheTotalAmount = 0;
                let trancheTotalFacturable = 0;
                let trancheTotalProgress = 0;
                
                // Calculer les totaux de la tranche
                tranche.categories.forEach(category => {
                    trancheTotalAmount += category.amount;
                    const progress = calculateProgressAtDate(category, date);
                    trancheTotalFacturable += (category.amount * progress / 100);
                    trancheTotalProgress += progress;
                });
                
                const avgProgress = Math.round(trancheTotalProgress / tranche.categories.length);
                
                // Ligne principale de la tranche
                html += '<tr>';
                html += `<td class="tranche-name">${tranche.name}</td>`;
                html += `<td class="amount">${formatAmount(trancheTotalAmount)}</td>`;
                html += `<td class="percentage">${avgProgress}%</td>`;
                html += `<td class="amount">${formatAmount(trancheTotalFacturable)}</td>`;
                html += '</tr>';
                
                // Sous-lignes pour chaque cat√©gorie
                tranche.categories.forEach(category => {
                    const progress = calculateProgressAtDate(category, date);
                    const facturable = category.amount * progress / 100;
                    
                    html += '<tr>';
                    html += `<td class="sub-category">‚îî‚îÄ ${category.name}</td>`;
                    html += `<td class="amount">${formatAmount(category.amount)}</td>`;
                    html += `<td class="percentage">${progress}%</td>`;
                    html += `<td class="amount">${formatAmount(facturable)}</td>`;
                    html += '</tr>';
                });
                
                totalFacturable += trancheTotalFacturable;
            });
            
            tbody.innerHTML = html;
            
            // Mettre √† jour les montants totaux
            document.getElementById('totalFacturable').textContent = formatAmount(totalFacturable);
            document.getElementById('totalFacturableBottom').textContent = formatAmount(totalFacturable);
        }
        
        // Afficher la timeline des tranches
        function renderTimeline(date) {
            const labelsContainer = document.getElementById('timelineLabels');
            const barsContainer = document.getElementById('timelineBars');
            const data = projectData && projectData.financial 
                ? projectData.financial.tranches 
                : demoFinancialData.tranches;
            
            let labelsHtml = '';
            let barsHtml = '';
            
            data.forEach(tranche => {
                tranche.categories.forEach(category => {
                    const progress = calculateProgressAtDate(category, date);
                    const duration = category.endMonth - category.startMonth + 1;
                    const width = (duration / 12) * 100;
                    const left = (category.startMonth / 12) * 100;
                    
                    labelsHtml += `<div class="timeline-label">${tranche.name} - ${category.name}</div>`;
                    
                    barsHtml += `
                        <div class="timeline-bar-row">
                            <div class="timeline-bar" style="width: ${width}%; margin-left: ${left}%;">
                                <span class="timeline-bar-label">${progress}%</span>
                            </div>
                        </div>
                    `;
                });
            });
            
            labelsContainer.innerHTML = labelsHtml;
            barsContainer.innerHTML = barsHtml;
        }
        
        // Mettre √† jour le dashboard financier
        function updateFinancialDashboard() {
            renderFinancialTable(selectedDate);
            renderTimeline(selectedDate);
        }
        
        // Changer de vue principale
        function switchMainView(viewName) {
            currentView = viewName;
            
            // Masquer toutes les vues
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Afficher la vue s√©lectionn√©e
            if (viewName === 'home') {
                document.getElementById('home-view').classList.add('active');
            } else if (viewName === 'mechanical') {
                document.getElementById('mechanical-view').classList.add('active');
                updateChart(currentCategory, currentZone);
            } else if (viewName === 'electrical') {
                document.getElementById('electrical-view').classList.add('active');
                renderElectricalTable();
            } else if (viewName === 'financial') {
                document.getElementById('financial-view').classList.add('active');
                updateFinancialDashboard();
            }
        }
        
        // Navigation depuis la page d'accueil
        document.querySelectorAll('.dashboard-card').forEach(card => {
            card.addEventListener('click', function() {
                const dashboard = this.getAttribute('data-dashboard');
                if (dashboard === 'mechanical') {
                    switchMainView('mechanical');
                } else if (dashboard === 'electrical') {
                    switchMainView('electrical');
                } else if (dashboard === 'financial') {
                    switchMainView('financial');
                }
            });
        });
        
        // Boutons retour
        document.getElementById('btnBackFromMeca').addEventListener('click', function() {
            switchMainView('home');
        });
        
        document.getElementById('btnBackFromElec').addEventListener('click', function() {
            switchMainView('home');
        });
        
        document.getElementById('btnBackFromFinancial').addEventListener('click', function() {
            switchMainView('home');
        });
        
        // Mise √† jour des barres en fonction de la cat√©gorie et de la zone
        function updateChart(category, zone = 'all') {
            const categoryData = projectData ? projectData[category] : demoData[category];
            
            if (!categoryData) return;
            
            const data = categoryData[zone] || categoryData.all || categoryData;
            
            if (!data) return;
            
            // Appliquer les largeurs directement en pourcentage
            document.getElementById('bar1').style.width = data.cqReel + '%';
            document.getElementById('bar2').style.width = data.cqPrevu + '%';
            document.getElementById('bar3').style.width = data.reel + '%';
            document.getElementById('bar4').style.width = data.prevu + '%';
        }
        
        // Fonction pour obtenir la classe de couleur selon le pourcentage
        function getPercentageClass(percentage) {
            if (percentage >= 70) return 'high';
            if (percentage >= 40) return 'medium';
            return 'low';
        }
        
        // Afficher le tableau de progression √©lectrique
        function renderElectricalTable(filterAction = null) {
            const tbody = document.getElementById('progressTableBody');
            const data = projectData && projectData.electrical 
                ? projectData.electrical.actions 
                : demoElectricalData.actions;
            
            let filteredData = data;
            
            // Filtrer par action si s√©lectionn√©e
            if (filterAction && filterAction !== '') {
                // Extraire le num√©ro d'action (ex: "action1" -> 1)
                const actionNumber = parseInt(filterAction.replace('action', ''));
                if (!isNaN(actionNumber) && actionNumber > 0 && actionNumber <= data.length) {
                    filteredData = [data[actionNumber - 1]];
                }
            }
            
            let html = '';
            filteredData.forEach(action => {
                html += '<tr>';
                html += `<td class="action-name">${action.name}</td>`;
                html += `<td class="percentage ${getPercentageClass(action.ond1)}">${action.ond1}%</td>`;
                html += `<td class="percentage ${getPercentageClass(action.ond2)}">${action.ond2}%</td>`;
                html += `<td class="percentage ${getPercentageClass(action.ond3)}">${action.ond3}%</td>`;
                html += `<td class="percentage ${getPercentageClass(action.ond4)}">${action.ond4}%</td>`;
                html += `<td class="percentage ${getPercentageClass(action.ond5)}">${action.ond5}%</td>`;
                html += `<td class="percentage ${getPercentageClass(action.ond6)}">${action.ond6}%</td>`;
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
        }
        
        // Gestion des clics sur les onglets de cat√©gorie (Dashboard M√©canique)
        document.querySelectorAll('.tab-button[data-category]').forEach(button => {
            button.addEventListener('click', function() {
                const view = this.getAttribute('data-view');
                
                // Si on clique sur un bouton de la vue principale
                if (view === 'main') {
                    // Retirer la classe active de tous les boutons de cat√©gorie
                    document.querySelectorAll('.tab-button[data-category]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Ajouter la classe active au bouton cliqu√©
                    this.classList.add('active');
                    
                    // R√©cup√©rer la cat√©gorie
                    currentCategory = this.getAttribute('data-category');
                    
                    // Mettre √† jour le graphique avec la zone actuelle
                    updateChart(currentCategory, currentZone);
                }
            });
        });
        
        // Gestion des clics sur les onglets CQ
        document.querySelectorAll('.tab-button[data-cq]').forEach(button => {
            button.addEventListener('click', function() {
                // Retirer la classe active de tous les boutons CQ
                document.querySelectorAll('.tab-button[data-cq]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Ajouter la classe active au bouton cliqu√©
                this.classList.add('active');
                
                // R√©cup√©rer la cat√©gorie CQ
                const cqCategory = this.getAttribute('data-cq');
                
                // Mettre √† jour le graphique avec les donn√©es CQ et la zone actuelle
                updateChart(cqCategory, currentZone);
            });
        });
        
        // Gestion du changement de zone
        document.getElementById('zoneSelect').addEventListener('change', function() {
            const zone = this.value;
            console.log('Zone s√©lectionn√©e:', zone);
            
            // Mettre √† jour la zone actuelle
            currentZone = zone || 'all';
            
            // Mettre √† jour le graphique avec la nouvelle zone
            if (currentView === 'mechanical') {
                updateChart(currentCategory, currentZone);
            }
        });
        
        // Gestion du bouton "Tout voir"
        document.getElementById('btnViewAll').addEventListener('click', function() {
            document.getElementById('selectAction').value = '';
            renderElectricalTable();
        });
        
        // Gestion du changement de s√©lection d'action √©lectrique
        document.getElementById('selectAction').addEventListener('change', function() {
            const action = this.value;
            renderElectricalTable(action);
        });
        
        // Gestion du changement de date
        document.getElementById('dateSelector').addEventListener('change', function() {
            selectedDate = new Date(this.value);
            updateFinancialDashboard();
        });
        
        // Fonction pour charger les donn√©es depuis projectData (export MS Project)
        function loadProjectData(data) {
            projectData = data;
            
            if (currentView === 'mechanical') {
                updateChart(currentCategory, currentZone);
            } else if (currentView === 'electrical') {
                renderElectricalTable();
            } else if (currentView === 'financial') {
                updateFinancialDashboard();
            }
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Par d√©faut, on est sur la page d'accueil
            switchMainView('home');
            
            // Initialiser la date du s√©lecteur √† aujourd'hui
            const today = new Date();
            document.getElementById('dateSelector').valueAsDate = today;
            selectedDate = today;
        });
        
        // Exposition de la fonction pour le chargement futur
        window.loadProjectData = loadProjectData;
    </script>
</body>
</html>
</body>
</html>
