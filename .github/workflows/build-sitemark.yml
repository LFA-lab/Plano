name: Build Sitemark.exe

on:
  push:
    paths:
      - 'macros/export/sitemark_exe/sitemark.py'
      - 'macros/export/sitemark_exe/dashboard.py'
      - 'macros/export/sitemark_exe/requirements.txt'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r macros/export/sitemark_exe/requirements.txt
          pip install pyinstaller

      - name: Build EXE
        run: |
          cd macros/export/sitemark_exe
          pyinstaller --onefile --noconsole --hidden-import=pandas --hidden-import=plotly --hidden-import=plotly.express --hidden-import=plotly.graph_objects --hidden-import=openpyxl --hidden-import=openpyxl.cell._writer --hidden-import=numpy --add-data "logoomexom.png;." --add-data "vue aerienne centrale solaire.png;." --distpath . --name Sitemark sitemark.py

      - name: Clean Zone.Identifier
        run: |
          Get-ChildItem -Path macros/export/sitemark_exe -Recurse -Filter "*Zone.Identifier*" -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue

      - name: Update build date in sitemark.html
        run: |
          $date = Get-Date -Format "dd/MM/yyyy HH:mm"
          $path = "macros/export/sitemark_exe/sitemark.html"
          (Get-Content $path -Raw -Encoding UTF8) -replace '__EXE_BUILD_DATE__', $date | Set-Content $path -Encoding UTF8

      - name: Commit and push EXE and page
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add macros/export/sitemark_exe/Sitemark.exe macros/export/sitemark_exe/sitemark.html
          git commit -m "ci: update Sitemark.exe and build date"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
