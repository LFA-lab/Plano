name: Build Sitemark.exe

on:
  push:
    paths:
      - 'macros/export/sitemark_exe/sitemark.py'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pymupdf pdfplumber openpyxl pillow requests pyinstaller

      - name: Build EXE
        run: |
          cd macros/export/sitemark_exe
          pyinstaller --onefile --noconsole --name "Sitemark" sitemark.py

      - name: Move EXE and clean Zone.Identifier
        run: |
          Copy-Item macros/export/sitemark_exe/dist/Sitemark.exe macros/export/sitemark_exe/Sitemark.exe
          Get-ChildItem -Path macros/export/sitemark_exe -Recurse -Filter "*Zone.Identifier*" -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue

      - name: Commit and push EXE
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add macros/export/sitemark_exe/Sitemark.exe
          git commit -m "ci: update Sitemark.exe"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
